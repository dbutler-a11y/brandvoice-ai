// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User model for authentication and authorization
model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String?
  avatarUrl String?
  role      UserRole @default(CLIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clientUsers ClientUser[]
}

// Enum for user roles
enum UserRole {
  CLIENT
  ADMIN
}

// Junction table to link Users to Clients (for client portal access)
model ClientUser {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  clientId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([userId])
  @@index([clientId])
}

model Client {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  businessName String
  contactName  String
  email        String
  phone        String?
  website      String?
  niche        String
  tone         String
  goals        String   @db.Text
  notes        String?  @db.Text

  // Payment tracking fields
  paymentStatus String   @default("unpaid") // "unpaid", "paid", "refunded", "failed"
  paymentAmount Int?     // amount in cents
  paymentDate   DateTime?
  paymentMethod String?  // e.g., "paypal", "venmo", "wave", "cash"

  // Package tracking
  package               String?   // "launch-kit", "content-engine", "content-engine-pro", "authority-engine"
  packagePrice          Int?      // Price in cents
  isSubscription        Boolean   @default(false)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  paypalSubscriptionId  String?   // PayPal subscription ID for webhook lookups

  // Subscription management
  failedPaymentCount    Int       @default(0) // Track failed payment attempts
  needsWinBack          Boolean   @default(false) // Flag for win-back campaigns

  // Add-ons tracking
  addOns      String? @db.Text // JSON string: ["custom-avatar", "custom-voice", "promo-pack", "posting", "facebook-ads"]
  addOnsTotal Int?             // Total add-ons price in cents

  // Project status workflow (8 steps + special states)
  projectStatus       String    @default("discovery") // "discovery", "onboarding", "avatar-creation", "scriptwriting", "video-production", "qa-review", "delivered", "ongoing", "paused", "disputed"
  projectStartDate    DateTime?
  projectDeliveryDate DateTime?

  // Avatar/Voice tracking
  avatarId        String? // Reference to selected/created avatar
  voiceId         String? // ElevenLabs voice ID
  voicePreference String? // Voice tone preference

  // Facebook Ad Campaign (if add-on purchased)
  fbAdCampaignStatus String? // "not-started", "discovery", "writing", "production", "delivered", "revisions", "finalized"
  fbAdCampaignNotes  String? @db.Text

  // Relations
  intake         Intake?
  scripts        Script[]
  clientUsers    ClientUser[]
  clientAssets   ClientAsset[]
  orders         Order[]
  disputes       Dispute[]
  refunds        Refund[]
  studioProjects StudioProject[]
}

// ClientAsset model for storing video/file references
model ClientAsset {
  id          String   @id @default(uuid()) @db.Uuid
  clientId    String
  fileName    String
  fileUrl     String
  fileType    String   // e.g., "video/mp4", "image/png", "application/pdf"
  fileSize    BigInt   // file size in bytes
  uploadedAt  DateTime @default(now())
  description String?  @db.Text

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model Intake {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  clientId        String   @unique
  rawFaqs         String   @db.Text
  rawOffers       String   @db.Text
  rawTestimonials String   @db.Text
  rawPromos       String   @db.Text
  brandVoiceNotes String   @db.Text
  references      String   @db.Text
  assetsFolder    String?
  brandColors     String?
  logoUrl         String?

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Script {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  clientId        String
  type            String   // FAQ, SERVICE, PROMO, TESTIMONIAL, TIP, BRAND
  title           String
  scriptText      String   @db.Text
  durationSeconds Int?
  status          String   @default("draft") // draft, approved, exported
  notes           String?  @db.Text

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

// Lead model for capturing prospects from voice agent conversations
model Lead {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contact Information (Required)
  fullName  String?
  email     String?
  phone     String?

  // Business Information
  businessName     String?
  businessType     String?  // Industry/niche
  website          String?

  // Products & Services
  productsServices String?  @db.Text // What they offer
  targetAudience   String?  @db.Text // Who they serve

  // Video Marketing Goals
  videoGoals           String?  @db.Text // What they want to achieve
  currentVideoStrategy String?  @db.Text // Are they creating video now? How?

  // Budget & Timeline
  timeline        String?  // When they want to start
  budgetAllocated String?  // Have they budgeted for video marketing?
  budgetRange     String?  // Approximate budget range

  // Platform & Content Preferences
  socialPlatforms     String?  @db.Text // Which platforms they use
  contentTopics       String?  @db.Text // Topics they want covered
  competitorExamples  String?  @db.Text // Competitors they like

  // Spokesperson Preferences
  spokespersonGender String?  // Preferred gender
  spokespersonAge    String?  // Preferred age range
  spokespersonTone   String?  // Preferred tone/style

  // Add-on Interests
  interestedAddOns String?  @db.Text // JSON array: voice cloning, dubbing, etc.

  // Package Interest
  packageInterest String?  // Which package they're interested in

  // Discovery Info
  howHeardAboutUs   String?
  biggestChallenge  String?  @db.Text
  questionsOrConcerns String? @db.Text
  preferredCallTime String?

  // Lead Status & Tracking
  status         LeadStatus @default(NEW)
  score          Int        @default(0) // Lead quality score 0-100
  scoreBreakdown Json?      // Detailed scoring breakdown
  lastScoredAt   DateTime?  // Last time score was calculated
  isQualified    Boolean    @default(false)
  qualifiedAt    DateTime?
  convertedAt    DateTime?
  convertedToClientId String? // Reference to Client if converted

  // Source Tracking
  source         String     @default("voice_agent") // voice_agent, chat, form, etc.
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?

  // Data Quality
  dataQualityScore   Int      @default(0) // Percentage of fields filled
  validationStatus   String   @default("pending") // pending, validated, needs_review
  validationNotes    String?  @db.Text
  validatedAt        DateTime?

  // Follow-up
  lastContactedAt    DateTime?
  nextFollowUpAt     DateTime?
  followUpNotes      String?  @db.Text

  // Relations
  conversations VoiceConversation[]
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATING
  WON
  LOST
  NURTURING
}

// Voice Conversation model for storing ElevenLabs conversation logs
model VoiceConversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // ElevenLabs Data
  elevenLabsConversationId String?  @unique
  agentId                  String?

  // Lead Association
  leadId    String?
  lead      Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  // Conversation Metadata
  startedAt       DateTime?
  endedAt         DateTime?
  durationSeconds Int?

  // Transcript & Analysis
  transcript      String?  @db.Text // Full conversation transcript
  summary         String?  @db.Text // AI-generated summary
  extractedData   String?  @db.Text // JSON of extracted intake data

  // Sentiment & Quality
  sentiment       String?  // positive, neutral, negative
  intentDetected  String?  // purchase_intent, information_seeking, etc.

  // Call Outcome
  outcome         String?  // booked_call, requested_info, not_interested, etc.
  callBooked      Boolean  @default(false)
  bookedCallTime  DateTime?

  // Technical Data
  userAgent       String?
  ipAddress       String?

  @@index([leadId])
  @@index([elevenLabsConversationId])
}

// PayPal Orders
model Order {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // PayPal Info
  paypalOrderId      String   @unique
  paypalTransactionId String? // For tracking sale/capture transactions
  paypalStatus       String   // COMPLETED, PENDING, etc.

  // Customer Info
  payerEmail      String?
  payerName       String?

  // Package Info
  packageId       String
  packageName     String
  packagePrice    Int      // Amount in cents

  // Add-ons (JSON)
  addOns          String?  @db.Text // JSON array of add-ons

  // Totals
  addOnsTotal     Int      @default(0) // In cents
  totalAmount     Int      // Total in cents

  // Fulfillment
  status          String   @default("paid") // paid, processing, fulfilled, refunded
  clientId        String?  // Reference to Client if converted
  notes           String?  @db.Text

  // Relations
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  disputes        Dispute[]
  refunds         Refund[]

  @@index([paypalOrderId])
  @@index([paypalTransactionId])
  @@index([payerEmail])
  @@index([clientId])
}

// AI Spokesperson characters available for clients
model Spokesperson {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Basic Info
  name            String   // e.g., "Sarah", "Marcus"
  displayName     String   // e.g., "Sarah - The Beauty Expert"
  description     String   @db.Text // Short bio/description

  // Industry Focus
  primaryNiche    String   // e.g., "Med Spa / Aesthetics"
  secondaryNiches String?  @db.Text // Comma-separated other niches they work for

  // Character Traits
  tone            String   // e.g., "Luxury, Sophisticated"
  personality     String   // e.g., "Warm, Professional, Knowledgeable"
  ageRange        String   // e.g., "30-40"
  gender          String   // e.g., "Female", "Male", "Non-binary"

  // Visual Assets
  avatarUrl       String?  // Profile image URL
  thumbnailUrl    String?  // Small thumbnail
  demoVideoUrl    String?  // Sample video URL (YouTube/Vimeo embed)
  demoVideoThumb  String?  // Video thumbnail image

  // Customization Options (JSON strings for flexibility)
  hairOptions     String?  @db.Text // JSON: ["blonde", "brunette", "black", "red"]
  clothingOptions String?  @db.Text // JSON: ["business", "casual", "medical"]
  backgroundOptions String? @db.Text // JSON: ["office", "studio", "outdoor"]

  // Voice Info
  voiceSample     String?  // Audio sample URL
  voiceStyle      String?  // e.g., "Warm and articulate"
  accentOptions   String?  @db.Text // JSON: ["American", "British", "Neutral"]

  // Pricing & Availability
  tier            String   @default("standard") // "standard", "premium", "exclusive"
  basePrice       Int      @default(997) // Price in cents ($9.97 = 997)
  isAvailable     Boolean  @default(true)
  isExclusive     Boolean  @default(false) // If claimed by a client
  exclusiveToId   String?  // Client ID if exclusive

  // VidBuzz Integration
  vidbuzzActorId  String?  // ID in VidBuzz system
  vidbuzzVoiceId  String?  // Voice ID in VidBuzz

  // Stats
  timesUsed       Int      @default(0)
  avgRating       Float?   // Client satisfaction rating

  // Ordering
  sortOrder       Int      @default(0)
  featured        Boolean  @default(false)
}

// Reminder model for follow-ups and task management
model Reminder {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  dueAt       DateTime
  completedAt DateTime?

  type        String   // "follow_up", "payment_reminder", "check_in"
  title       String
  description String?  @db.Text
  priority    String   @default("normal") // low, normal, high, urgent

  leadId      String?
  clientId    String?

  status      String   @default("pending") // pending, completed, snoozed, cancelled

  @@index([dueAt])
  @@index([status])
}

// Webhook event logging for external services (PayPal, ElevenLabs, etc.)
model WebhookLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  source      String   // "paypal", "elevenlabs", etc.
  eventType   String
  eventId     String?  @unique
  payload     String   @db.Text
  status      String   @default("received") // received, processed, failed
  error       String?  @db.Text
  processedAt DateTime?

  @@index([source])
  @@index([eventType])
  @@index([createdAt])
}

// PayPal Disputes model for tracking customer disputes and chargebacks
model Dispute {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // PayPal dispute identifiers
  disputeId      String   @unique
  transactionId  String?  // PayPal transaction/sale ID

  // Associated records
  orderId        String?
  clientId       String?

  // Dispute details
  amount         Int?     // Amount in cents
  currency       String   @default("USD")
  reason         String   // e.g., "merchandise_or_service_not_received"
  status         String   // open, resolved, etc.
  outcome        String?  // RESOLVED, BUYER_FAVOUR, SELLER_FAVOUR
  resolutionType String?  // dispute_life_cycle_stage

  // Timestamps
  resolvedAt     DateTime?

  // Raw PayPal payload for reference
  disputeDetails String   @db.Text // JSON

  // Relations
  order          Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  client         Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([disputeId])
  @@index([orderId])
  @@index([clientId])
  @@index([status])
}

// PayPal Refunds model for tracking refunded payments
model Refund {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // PayPal refund identifiers
  refundId      String   @unique
  transactionId String?  // PayPal sale/capture ID

  // Associated records
  orderId       String?
  clientId      String?

  // Refund details
  amount        Int?     // Amount in cents
  currency      String   @default("USD")
  refundType    String   // full, partial
  status        String   // completed, pending, failed

  // Timestamps
  refundedAt    DateTime

  // Raw PayPal payload for reference
  refundDetails String   @db.Text // JSON

  // Relations
  order         Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  client        Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([refundId])
  @@index([orderId])
  @@index([clientId])
  @@index([status])
}

// Alert model for admin notifications about important events
model Alert {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Alert classification
  type      String   // dispute_created, dispute_resolved, payment_refunded, etc.
  severity  String   // low, medium, high, critical
  title     String
  message   String   @db.Text

  // Additional context (JSON)
  metadata  String?  @db.Text

  // Status tracking
  isRead    Boolean  @default(false)
  readAt    DateTime?
  readBy    String?  // Admin user ID who read the alert

  // Actions taken
  isResolved   Boolean  @default(false)
  resolvedAt   DateTime?
  resolvedBy   String?  // Admin user ID who resolved
  resolution   String?  @db.Text // Notes about how it was resolved

  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
}

// =============================================
// ATHLETE AD STUDIO MODELS
// =============================================

// Athlete Studio Project - contains multiple athletes and frames
model StudioProject {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  name            String
  description     String   @db.Text
  status          String   @default("active") // active, paused, completed, archived

  // Project type and channel
  projectType     String   @default("brand_campaign") // brand_campaign, product_launch, seasonal, ambassador_program
  primaryChannel  String   @default("instagram") // instagram, tiktok, youtube, multi_platform
  primaryGoal     String?  @db.Text

  // Client association (links to main BrandVoice client)
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  brandName       String?

  // BrandVoice offer reference
  offerId         String?

  // Relations
  athletes        StudioAthlete[]

  @@index([clientId])
  @@index([status])
}

// Athletes in a studio project
model StudioAthlete {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  projectId       String
  project         StudioProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  sport           String
  notes           String?  @db.Text

  // Relations
  frames          StudioFrame[]

  @@index([projectId])
}

// Individual frames/storyboard items for an athlete
model StudioFrame {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  athleteId       String
  athlete         StudioAthlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  // Frame content
  order           Int      @default(1)
  label           String
  description     String   @db.Text
  aiPrompt        String?  @db.Text

  // Status workflow: idea -> prompt_ready -> sent_to_ai -> rendered -> revision_requested -> approved
  status          String   @default("idea")

  // Media
  imageUrl        String?
  thumbnailUrl    String?

  // Production tracking
  priority        String   @default("normal") // low, normal, high, urgent
  dueDate         DateTime?
  assignedTo      String?

  // External links (JSON array)
  externalLinks   String?  @db.Text

  // Checkpoints (JSON array)
  checkpoints     String?  @db.Text

  // Revisions history (JSON array)
  revisions       String?  @db.Text

  // Notes/comments (JSON array)
  notes           String?  @db.Text

  @@index([athleteId])
  @@index([status])
  @@index([priority])
}

// =============================================
// BLOG MODELS
// =============================================

// Blog Post model for SEO-optimized articles
model BlogPost {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // URL & SEO
  slug            String   @unique
  title           String
  metaTitle       String?  // SEO title (falls back to title if not set)
  metaDescription String?  @db.Text // SEO description
  metaKeywords    String?  // SEO keywords (comma-separated)
  canonicalUrl    String?  // For duplicate content management

  // Content
  excerpt         String   @db.Text // Short preview for cards
  content         String   @db.Text // Main article content (HTML or Markdown)
  contentFormat   String   @default("markdown") // "markdown" or "html"

  // Media
  featuredImage   String?  // Main hero image URL
  featuredImageAlt String? // Alt text for accessibility & SEO
  ogImage         String?  // Open Graph image (social sharing)

  // Categorization
  categoryId      String?
  category        BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags            BlogPostTag[]

  // Author
  authorId        String?
  author          BlogAuthor? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  // Status & Visibility
  status          BlogPostStatus @default(DRAFT)
  featured        Boolean  @default(false) // Show in featured section

  // Reading stats
  readingTime     Int?     // Estimated minutes to read
  wordCount       Int?

  // Engagement (can be updated via n8n)
  viewCount       Int      @default(0)

  // SEO Schema
  schemaType      String   @default("Article") // Article, BlogPosting, NewsArticle, etc.

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([categoryId])
  @@index([featured])
}

enum BlogPostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

// Blog Category for organizing posts
model BlogCategory {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  name            String   @unique
  slug            String   @unique
  description     String?  @db.Text
  color           String?  // Hex color for UI
  icon            String?  // Icon name or emoji

  // SEO
  metaTitle       String?
  metaDescription String?  @db.Text

  // Ordering
  sortOrder       Int      @default(0)

  // Relations
  posts           BlogPost[]

  @@index([slug])
}

// Blog Tags for flexible tagging
model BlogTag {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())

  name            String   @unique
  slug            String   @unique

  // Relations
  posts           BlogPostTag[]

  @@index([slug])
}

// Junction table for many-to-many Post <-> Tag relationship
model BlogPostTag {
  id              String   @id @default(cuid())
  postId          String
  tagId           String

  post            BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag             BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// Blog Author for multi-author support
model BlogAuthor {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  name            String
  slug            String   @unique
  email           String?
  bio             String?  @db.Text
  avatar          String?  // Profile image URL
  title           String?  // Job title
  company         String?  // Company name

  // Social links
  twitter         String?
  linkedin        String?
  website         String?

  // Relations
  posts           BlogPost[]

  @@index([slug])
}

// Blog Topic Queue for automated content generation
model BlogTopic {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Topic details
  title           String   // The topic/headline to write about
  pillar          String   // Content pillar: ai-video, business-growth, platform-strategy
  primaryKeyword  String   // Main SEO keyword to target
  secondaryKeywords String? // Comma-separated secondary keywords
  searchIntent    String   @default("informational") // informational, transactional, navigational

  // SEO data
  searchVolume    Int?     // Estimated monthly searches
  difficulty      Int?     // 1-100 keyword difficulty score
  priority        Int      @default(50) // 1-100, higher = more important

  // Scheduling
  scheduledFor    DateTime? // When to generate/publish
  status          String   @default("queued") // queued, generating, published, failed

  // Generation tracking
  generatedPostId String?  // Links to BlogPost once created
  generatedAt     DateTime?
  errorMessage    String?  @db.Text

  // Content guidance
  targetAudience  String?  // Who this content is for
  contentAngle    String?  @db.Text // Unique angle/hook for the article
  internalLinks   String?  @db.Text // Suggested internal links (JSON array)

  @@index([status])
  @@index([scheduledFor])
  @@index([pillar])
}
